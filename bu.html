<!DOCTYPE html>
<html lang="ru">
<head>
<title>Расчёт хлебных единиц</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<style>

/*Таблицы в строку*/
.container{overflow:hidden;width:auto}
.contcells{white-space:nowrap}
.contcells div{width:auto;float:left;border:1px} /*display: inline-block; or float:left*/

/*Формат полей ввода*/
input[type=number]{font-family:inherit;font-size:inherit;width:100px;}

/*Таблицы*/
table{border:1px solid #eee;border-collapse:collapse;table-layout:fixed;margin-bottom:20px;}
table caption{font-weight:bold;padding:5px;background:#98aa8b;border:1px solid #dddddd;}
table th{font-weight:bold;padding:5px;background: #efefef;border:1px solid #dddddd;}
table td{padding:5px 10px;text-align:left;border-top: 1px solid #98aa8b;}
table tbody tr:nth-child(odd){background:#fff;}
table tbody tr:nth-child(even){background:#c3d4b7;}
table tfoot{font-weight:bold;}
table tfoot td{border:1px solid #98aa8b;}

/*Список продуктов*/
#listBlock {display:inline-block;}
ul li{margin:5px;border: 1px;}
ul, #productUL{list-style-type:none;}
#prodItem:hover{background:#a3f06c;margin:5px;}
#productUL{margin:0;padding:5;}
.caret{cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
.caret::before{content:"\25B6";color:black;display:inline-block;margin-right:6px;}
.caret-down::before{-ms-transform:rotate(90deg);-webkit-transform:rotate(90deg);transform:rotate(90deg);}
.nested{display:none;}
.active{display:block;}

/*Кнопки удаления строк*/
.delbutton{padding-left:0px;padding-right:0px;}

</style>
</head>
<body>

<p>Углеводов (Carbohydrate) в одной хлебной единице: <td><select id="carbInBuId"><option selected=true value=12>12</option><option value=11>11</option><option value=10>10</option></select></td></p>

<div class="container"><div class="contcells"><div>
<table id="tDish">
  <caption>Приготовить блюдо (клик по продукту из списка)</caption>
  <thead><tr><th>Продукт</th><th>Масса<br>продукта</th><th>Углеводы</th><th>ХЕ</th><th><input id="delRowsButton" type='button' disabled value='Удалить всё'></th><th>Углеводы<br>на 100г.</th></tr></thead>
  <tbody></tbody>
  <tfoot><tr><td>Итого суммарно</td><td>0</td><td>0</td><td>0.0</td><td><input id="fillMealButton" type='button' disabled value='В перекус'></td><td></td></tr></tfoot>
</table>
</div>
<div>
<table id="tMeal">
  <caption>Составить перекус (ctrl+клик по продукту из списка)</caption>
  <thead><tr><th>Перекус</th><th>Масса<br>продукта</th><th>Углеводы</th><th>ХЕ</th><th>Установить<br>ХЕ</th><th><input id="delRowsButton" type='button' disabled value='Удалить всё'></th></tr></thead>
  <tbody></tbody>
  <tfoot><tr><td>Итого суммарно</td><td>0</td><td>0</td><td>0.0</td><td></td><td></td></tr></tfoot>
</table>
</div></div></div>

<div id="listBlock">
<ul id="productUL">
  <li><span class="caret">Каши</span><ul class="nested">
      <li id="prodItem" data-c="60.0">Хлопья гречневые ЯсноСолнышко</li>
      <li id="prodItem" data-c="72.0">Хлопья из полбы Агро-Альянс</li>
      <li id="prodItem" data-c="78.33">Хлопья кукурзные Мистраль</li>
      <li id="prodItem" data-c="60.0">Хлопья овсяные ЯсноСолнышко</li>
			<li id="prodItem" data-c="75.0">Хлопья пшенные Nordic</li>
      <li id="prodItem" data-c="74.0">Хлопья рисовые ЯсноСолнышко</li>
  </ul></li>
  <li><span class="caret">Молочные продукты</span><ul class="nested">
	    <li id="prodItem" data-c="0.0">Вода</li>
      <li id="prodItem" data-c="0.8">Масло сливочное Вкуснотеево 82.5%</li>
      <li id="prodItem" data-c="0.9">Масло сливочное Простоквашино 82%</li>
      <li id="prodItem" data-c="4.7">Молоко</li>
			<li id="prodItem" data-c="4.7">Молоко топлёное Олония 4%</li>
      <li id="prodItem" data-c="4.0">Кефир</li>
			<li id="prodItem" data-c="4.2">Ряженка Олония 4.0%</li>
	    <li id="prodItem" data-c="4.0">Ацидофилин Олония 2.5%</li>
	    <li id="prodItem" data-c="2.9">Сметана Брест-Литовск 20%</li>
	    <li id="prodItem" data-c="2.5">Сметана Простоквашино 20%</li>
      <li id="prodItem" data-c="3.0">Творог Олония 5%</li>
  </ul></li>
  <li><span class="caret">Мучные продукты</span><ul class="nested">
      <li id="prodItem" data-c="85.0">Крахмал кукурузный Haas</li>
      <li id="prodItem" data-c="69.7">Макароны Barilla</li>
      <li id="prodItem" data-c="70.6">Мука Селяночка пшеничная ВС</li>
      <li id="prodItem" data-c="60.0">Мука Увелка цельнозерновая</li>
			<li id="prodItem" data-c="19.6">Разрыхрытель теста Dr.Oetker</li>
      <li id="prodItem" data-c="39.9">Хлеб ржаной</li>
      <li id="prodItem" data-c="50.0">Хлеб бородинский</li>
	    <li id="prodItem" data-c="57.1">Хлебцы молодцы Витамин+Иммунитет</li>
			<li id="prodItem" data-c="63.0">Хлебцы FinnCrisp</li>
  </ul></li>
  <li><span class="caret">Крупы</span><ul class="nested">
      <li id="prodItem" data-c="68.0">Греча Тёплые традиции</li>
			<li id="prodItem" data-c="70.0">Манка ЯсноСолнышко</li>
      <li id="prodItem" data-c="57.0">Нут Мистраль</li>
      <li id="prodItem" data-c="62.0">Овёс резаный Myllyn Paras</li>
      <li id="prodItem" data-c="73.0">Полба цельнозерновая Увелка</li>
      <li id="prodItem" data-c="67.4">Пшено Мистраль</li>
      <li id="prodItem" data-c="76.0">Рис Агро-Альянс жасмин</li>
      <li id="prodItem" data-c="60.0">Толокно овсяное С.Пудовъ</li>
  </ul></li>
  <li><span class="caret">Овощи</span><ul class="nested">
		<li><span class="caret">Овощи замороженные</span><ul class="nested">
      <li id="prodItem" data-c="18.4">Горох зелёный замороженный Лента</li>
			<li id="prodItem" data-c="4.5">Капуста брокколи замороженная 4Сезона</li>
			<li id="prodItem" data-c="4.5">Капуста цветная замороженная 4Сезона</li>
			<li id="prodItem" data-c="40.0">Кукуруза замороженная 4Сезона</li>
			<li id="prodItem" data-c="5.4">Перец сладкий нарезанный зам. 4Сезона</li>
			<li id="prodItem" data-c="4.0">Фасоль зелёная стручковая зам. 4Сезона</li>
		</ul></li>
			<li id="prodItem" data-c="57.7">Горох лущеный*</li>
			<li id="prodItem" data-c="4.6">Кабачки*</li>
			<li id="prodItem" data-c="4.7">Капуста белокочанная*</li>
			<li id="prodItem" data-c="16.1">Картофель*</li>
			<li id="prodItem" data-c="4.6">Лук зелёный (перо)*</li>
			<li id="prodItem" data-c="10.4">Лук репчатый*</li>
			<li id="prodItem" data-c="6.9">Морковь*</li>
			<li id="prodItem" data-c="5.3">Перец красный сладкий*</li>
			<li id="prodItem" data-c="8.1">Петрушка зелень*</li>
			<li id="prodItem" data-c="3.7">Помидор(Томат)*</li>
			<li id="prodItem" data-c="8.8">Свекла*</li>
			<li id="prodItem" data-c="3.0">Сельдерей*</li>
		  <li id="prodItem" data-c="7.7">Тыква</li>
  </ul></li>
	<li><span class="caret">Фрукты</span><ul class="nested">
	    <li id="prodItem" data-c="21.8">Банан*</li>
			<li id="prodItem" data-c="12.4">Груша</li>
			<li id="prodItem" data-c="9.9">Крыжовник*</li>
			<li id="prodItem" data-c="9.0">Малина*</li>
			<li id="prodItem" data-c="8.6">Мандарин*</li>
			<li id="prodItem" data-c="8.6">Черника*</li>
			<li id="prodItem" data-c="11.3">Яблоко</li>
	</ul></li>
	<li><span class="caret">Соки, пюре</span><ul class="nested">
	    <li id="prodItem" data-c="9.0">Пюре яблочное ФрутоНяня</li>
			<li id="prodItem" data-c="11.2">Сок яблочный осветлённый ФрутоНяня</li>
	</ul></li>
  <li><span class="caret">Кондитерские изделия</span><ul class="nested">
      <li id="prodItem" data-c="100.0">Сахар белый Продимпекс</li>
      <li id="prodItem" data-c="96.0">Сахар тростниковый Мусковадо тёмный</li>
  </ul></li>
</ul>
</div>

<script>

function addEvent(obj, type, fn) {
  if (obj.addEventListener) {
    obj.addEventListener(type, fn, false);
  }
  else if (obj.attachEvent) {
    obj["e"+type+fn] = fn;
    obj[type+fn] = function() {obj["e"+type+fn](window.event);}
    obj.attachEvent("on"+type, obj[type+fn]);
  }
  else {
    obj["on"+type] = obj["e"+type+fn];
  }
}

window.onload = function() {
	//костыль для стиля
	const h = document.getElementById('tDish').rows[1].clientHeight;
	let tMref = document.getElementById('tMeal');
	tMref.rows[1].style.height = h + "px";
}

function addEventCustomHint(x) {
  addEvent(x, 'input', ()=>{
    if (x.validity.rangeUnderflow || x.validity.badInput || x.validity.typeMismatch || x.validity.stepMismatch) {
      x.setCustomValidity("Введите целое число большее 0.");
    }
    else {
      x.setCustomValidity("");
    }})
}

let carbInBu = 12.0;

function updatecarbInBu() {
	carbInBu = document.getElementById("carbInBuId").value;
  ["tDish", "tMeal"].forEach(function(table) {
		let tBref = document.getElementById(table).tBodies[0];
		Array.prototype.forEach.call(tBref.rows, function(item) {
			item.cells[3].innerHTML = (parseFloat(item.cells[2].innerHTML)/carbInBu).toFixed(3)
    });
		updateTableFooter(table);
  })
	Array.prototype.forEach.call(document.getElementById("tMeal").tBodies[0].rows, (item) => updateMealWeight(item));
	updateTableFooter("tMeal");
}

function updateMealWeight(x) {
  let tBref = document.getElementById("tMeal").tBodies[0];
	let weightRef = document.getElementById("tMeal").tBodies[0].rows[x.rowIndex-1].cells[1].getElementsByTagName('input')[0];
  const xeAmount = parseFloat(tBref.rows[x.rowIndex-1].cells[4].getElementsByTagName('select')[0].value);
	if (xeAmount == 0.0) return;
  weightRef.value = Math.round((weightRef.value * xeAmount)/parseFloat(tBref.rows[x.rowIndex-1].cells[3].innerHTML));
  tBref.rows[x.rowIndex-1].cells[2].innerHTML = (xeAmount * carbInBu).toFixed(1);
  tBref.rows[x.rowIndex-1].cells[3].innerHTML = xeAmount;
}

function processWChange(x) {
  let selectref = x.parentElement.parentElement.cells[4].getElementsByTagName("select")[0];
	if (x.parentElement.parentElement.cells[4].innerHTML == '') {
		updateTableFooter("tMeal");
		return;
	}
	if (x.validity.valid) {
		if (selectref.style.display === "none")	selectref.style.display = "block";
		updateTableFooter("tMeal");
  }
	else {
		selectref.style.display = "none";
	}
}

function fillTMealBody() {
  const src = document.getElementById("tDish");
  const tbodyRowCount = src.tBodies[0].rows.length;
  let dst = document.getElementById("tMeal").getElementsByTagName('tbody')[0];
  dst.insertRow().innerHTML =
    "<td>Составное блюдо</td>"
  + "<td><input type='number' value='" + src.rows[tbodyRowCount+1].cells[1].innerHTML + "' min='1'></td>"
	+ "<td>" + src.rows[tbodyRowCount+1].cells[2].innerHTML + "</td>"
	+ "<td>" + src.rows[tbodyRowCount+1].cells[3].innerHTML + "</td>"
	+ "<td><select><option selected=true disabled=disabled value=0.0>ХЕ0.0</option><option value=0.5>ХЕ0.5</option><option value=1>ХЕ1</option><option value=1.5>ХЕ1.5</option><option value=2>ХЕ2</option><option value=2.5>ХЕ2.5</option><option value=3>ХЕ3</option><option value=3.5>ХЕ3.5</option></select></td>"
	+ "<td><input class='delbutton' type='button' value='Удалить строку'></td>";
  let rowRef = dst.rows[dst.rows.length-1];
  addEvent(rowRef.querySelector('input'), 'change', ()=>processWChange(rowRef.querySelector('input')));
  addEvent(rowRef.querySelector('select'), 'change', ()=>{updateMealWeight(rowRef); updateTableFooter("tMeal");});
  addEvent(rowRef.querySelector('.delbutton'), 'click', ()=>{delRow("tMeal", rowRef); updateTableFooter("tMeal");});
	addEventCustomHint(rowRef.cells[1].getElementsByTagName("input")[0]);
  if (src.rows[tbodyRowCount+1].cells[2].innerHTML == 0.00) rowRef.cells[4].innerHTML = '';
	let btn = document.getElementById('tMeal').querySelector('#delRowsButton');
	if (btn.disabled == true) btn.disabled = false
}

function updateTableFooter(tableId) {
  let table = document.getElementById(tableId);
  let sum = Array.prototype.reduce.call(table.tBodies[0].rows, function(acc, item) {
    return acc + parseInt(item.cells[1].getElementsByTagName("input")[0].value, 10)
  },0);
  table.lastElementChild.lastElementChild.cells[1].innerHTML = sum;
  sum = Array.prototype.reduce.call(table.tBodies[0].rows, function(acc, item) {
    return acc + parseFloat(item.cells[2].innerHTML)
  },0);
  table.lastElementChild.lastElementChild.cells[2].innerHTML = (sum).toFixed(2);
  table.lastElementChild.lastElementChild.cells[3].innerHTML = (sum/carbInBu).toFixed(3);
}

function updateCarbInRow(x) {
	if (x.cells[1].getElementsByTagName("input")[0].validity.valid === false) x.cells[1].getElementsByTagName("input")[0].value = 100;
  x.cells[2].innerHTML = ((x.cells[1].getElementsByTagName("input")[0].value * parseFloat(x.cells[5].innerHTML))/100.0).toFixed(2);
  x.cells[3].innerHTML = (parseFloat(x.cells[2].innerHTML)/carbInBu).toFixed(3);
}

function delRow(tableId, x) {
	const table = document.getElementById(tableId);
  document.getElementById(tableId).deleteRow(x.rowIndex);
  if (tableId == "tDish" && table.tBodies[0].rows.length == 0) {
		let btn = document.querySelector('#fillMealButton');
		btn.disabled = true;
		btn = document.getElementById(tableId).querySelector('#delRowsButton');
		btn.disabled = true;
  }
	if (tableId == "tMeal" && table.tBodies[0].rows.length == 0) {
		let btn = document.getElementById(tableId).querySelector('#delRowsButton');
		btn.disabled = true;
  }
}

function dellRows(tableId) {
	let tbodyRef = document.getElementById(tableId).tBodies[0];
	tbodyRef.innerHTML = '';
	if (tableId == "tDish") {
		let btn = document.querySelector('#fillMealButton');
		btn.disabled = true;
	}
}

Array.prototype.forEach.call(document.getElementsByClassName("caret"), function(item) {
	item.addEventListener("click", function() {
    this.parentElement.querySelector(".nested").classList.toggle("active");
    this.classList.toggle("caret-down");
	});
});

let items = document.querySelectorAll("#productUL #prodItem");
let product = [],
    carbs = [];

// add values to the array
items.forEach(function(item){
  product.push(item.innerHTML);
	carbs.push(item.getAttribute("data-c"));
})

// get selected element index
items.forEach(function(item){
  item.onclick = function(event){
    const index = product.indexOf(this.innerHTML);
    if (index != -1) {
      if (event.ctrlKey) {
				let btn = document.getElementById('tMeal').querySelector('#delRowsButton');
				if (btn.disabled == true) btn.disabled = false
        // Заполняем данными строку таблицы tMeal
        let tbodyRef = document.getElementById('tMeal').getElementsByTagName('tbody')[0];
        // Insert a row at the end of table
        tbodyRef.insertRow().innerHTML =
            "<td>" + product[index] + "</td>"
          + "<td><input type='number' value='100' min='1'></td>"
          + "<td>" + carbs[index] + "</td>"
          + "<td>" + (carbs[index]/carbInBu).toFixed(3) + "</td>"
          + "<td><select><option selected=true disabled=disabled value=0.0>ХЕ0.0</option><option value=0.5>ХЕ0.5</option><option value=1>ХЕ1</option><option value=1.5>ХЕ1.5</option><option value=2>ХЕ2</option><option value=2.5>ХЕ2.5</option><option value=3>ХЕ3</option><option value=3.5>ХЕ3.5</option></select></td>"
          + "<td><input class='delbutton' type='button' value='Удалить строку'></td>";
        let rowRef = tbodyRef.rows[tbodyRef.rows.length-1];
				addEvent(rowRef.querySelector('input'), 'change', ()=>processWChange(rowRef.querySelector('input')));
        addEvent(rowRef.querySelector('select'), 'change', ()=>{updateMealWeight(rowRef); updateTableFooter("tMeal");});
        addEvent(rowRef.querySelector('.delbutton'), 'click', ()=>{delRow("tMeal", rowRef); updateTableFooter("tMeal");});
				addEventCustomHint(rowRef.cells[1].getElementsByTagName("input")[0]);
        if (carbs[index] == 0.0) rowRef.cells[4].innerHTML = '';
        updateTableFooter('tMeal');
      }
      else {
				let btn = document.querySelector('#fillMealButton');
				if (btn.disabled == true) btn.disabled = false
				btn = document.getElementById('tDish').querySelector('#delRowsButton');
				if (btn.disabled == true) btn.disabled = false
        // Заполняем данными строку таблицы tDish
        let tbodyRef = document.getElementById('tDish').getElementsByTagName('tbody')[0];
        // Insert a row at the end of table
        tbodyRef.insertRow().innerHTML =
            "<td>" + product[index] + "</td>"
          + "<td><input type='number' value='100' min='1'></td>"
          + "<td>" + carbs[index] + "</td>"
          + "<td>" + (carbs[index]/carbInBu).toFixed(3) + "</td>"
          + "<td><input class='delbutton' type='button' value='Удалить строку'></td>"
          + "<td>" + carbs[index] + "</td>";
        let rowRef = tbodyRef.rows[tbodyRef.rows.length-1];
        addEvent(rowRef.querySelector('input'), 'change', ()=>{updateCarbInRow(rowRef); updateTableFooter("tDish");});
        addEvent(rowRef.querySelector('.delbutton'), 'click', ()=>{delRow("tDish", rowRef); updateTableFooter("tDish");});
        updateTableFooter('tDish');
      }
    }
  };
})

function pageInit() {
  //setup events for static objects
  addEvent(document.getElementById('carbInBuId'), 'change', updatecarbInBu);
  addEvent(document.getElementById('fillMealButton'), 'click', ()=>{fillTMealBody(); updateTableFooter("tMeal");});
  addEvent(document.getElementById('tMeal').querySelector('#delRowsButton'), 'click', function(){dellRows("tMeal"); updateTableFooter("tMeal"); this.disabled = true;});
  addEvent(document.getElementById('tDish').querySelector('#delRowsButton'), 'click', function(){dellRows("tDish"); updateTableFooter("tDish"); this.disabled = true;});
}

pageInit();

</script>
</body>
</html>
